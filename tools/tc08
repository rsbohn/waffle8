#!/usr/bin/env python3
"""
TC08 magtape utility: read blocks from a .tu56 tape image.

Usage:
    tc08 read <tape-image> <block>

Prints the contents of the specified block in 8-word groups:
<offset>: <word0> <word1> ... <word7>

The tape format:
- twelve-bit words in 16-bit
- 256 words per block
- DIRECTORY is in block 1

"""
import sys
import struct
import os

def sixbit_char(val):
    c = val & 0x3F
    if c == 0:
        return ' '
    elif 1 <= c <= 26:
        return chr(ord('A') + c - 1)
    elif 27 <= c <= 36:
        return chr(ord('0') + c - 27)
    elif c == 46:
        return '.'
    else:
        return '_'

def sixbit_pair(word):
    return sixbit_char((word >> 6) & 0x3F) + sixbit_char(word & 0x3F)

def print_sixbit_pairs(words):
    for i in range(0, len(words), 8):
        chunk = words[i:i+8]
        chars = []
        for w in chunk:
            hi = sixbit_char((w >> 6) & 0x3F)
            lo = sixbit_char(w & 0x3F)
            chars.append(f"{hi}{lo}")
        chunk_str = ' '.join(chars)
        print(f"{i:04o}: {chunk_str}")

def unpack_16bit_words(data):
    words = []
    for i in range(0, len(data), 2):
        w = struct.unpack('<H', data[i:i+2])[0] & 0o7777
        words.append(w)
    return words

def read_block(image_path, block_num, sixbit_mode=False):
    BLOCK_SIZE_WORDS = 256
    PACKED_BLOCK_SIZE = 512  # 256 words * 2 bytes
    block_num = int(block_num)
    offset = block_num * PACKED_BLOCK_SIZE
    with open(image_path, 'rb') as f:
        f.seek(offset)
        data = f.read(PACKED_BLOCK_SIZE)
        if len(data) < PACKED_BLOCK_SIZE:
            print(f"Block {block_num} is incomplete or past end of file.", file=sys.stderr)
            sys.exit(1)
        words = unpack_16bit_words(data)
        if sixbit_mode:
            print_sixbit_pairs(words)
        else:
            for i in range(0, BLOCK_SIZE_WORDS, 8):
                chunk = words[i:i+8]
                chunk_str = ' '.join(f"{w:04o}" for w in chunk)
                print(f"{i:04o}: {chunk_str}")
    


# Move print_os8_directory above main()
def print_os8_directory(image_path, dir_block=1):
    BLOCK_SIZE_WORDS = 256
    PACKED_BLOCK_SIZE = 512
    offset = dir_block * PACKED_BLOCK_SIZE
    with open(image_path, 'rb') as f:
        f.seek(offset)
        data = f.read(PACKED_BLOCK_SIZE)
        if len(data) < PACKED_BLOCK_SIZE:
            print(f"Directory block {dir_block} is incomplete or past end of file.", file=sys.stderr)
            sys.exit(1)
        words = unpack_16bit_words(data)
        print("OS/8 Directory (block %d):" % dir_block)
        print("  FILE      EXT  START  LENGTH FLAGS")
        # Parse OS/8 directory segment header
        print("Header: " + ' '.join(f"{w:04o}" for w in words[:7]))
        dirent_num = 0
        entry_len = 6  # 6 words per entry: 0-2 filename, 3 ext, 4-5 attrs
        for i in range(7, BLOCK_SIZE_WORDS - entry_len + 1, entry_len):
            entry = words[i:i+entry_len]
            filename = sixbit_pair(entry[0]) + sixbit_pair(entry[1]) + sixbit_pair(entry[2])
            filename = filename.rstrip()
            ext = sixbit_pair(entry[3]).rstrip()
            attrs = ' '.join(f"{w:04o}" for w in entry[4:6])
            if filename.strip() == '' and ext.strip() == '':
                continue
            print(f"{dirent_num:2d}: {filename:<6} {ext:<2} ATTRS: {attrs}")
            dirent_num += 1

def main():
    import argparse
    parser = argparse.ArgumentParser(description="TC08 magtape utility")
    subparsers = parser.add_subparsers(dest="command")
    read_parser = subparsers.add_parser("read", help="Read and print a block")
    read_parser.add_argument("image", help="Tape image file")
    read_parser.add_argument("block", type=int, help="Block number")
    read_parser.add_argument("-s", "--sixbit", action="store_true", help="Print each word as two sixbit chars")
    dir_parser = subparsers.add_parser("dir", help="Print OS/8 directory entries")
    dir_parser.add_argument("image", help="Tape image file")
    args = parser.parse_args()

    if args.command == "read":
        if not os.path.isfile(args.image):
            print(f"File not found: {args.image}", file=sys.stderr)
            sys.exit(1)
        read_block(args.image, args.block, sixbit_mode=args.sixbit)
    elif args.command == "dir":
        if not os.path.isfile(args.image):
            print(f"File not found: {args.image}", file=sys.stderr)
            sys.exit(1)
        print_os8_directory(args.image)
    else:
        parser.print_help()
        sys.exit(2)

if __name__ == "__main__":
    main()
