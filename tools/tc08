#!/usr/bin/env python3
"""
TC08 magtape utility: read blocks from a .tu56 tape image.

Usage:
    tc08 read <tape-image> <block>

Prints the contents of the specified block in 8-word groups:
<offset>: <word0> <word1> ... <word7>
"""
import sys
import struct
import os

def read_block(image_path, block_num):
    BLOCK_SIZE_WORDS = 512
    WORD_SIZE = 2
    block_num = int(block_num)
    offset = block_num * BLOCK_SIZE_WORDS * WORD_SIZE
    with open(image_path, 'rb') as f:
        f.seek(offset)
        data = f.read(BLOCK_SIZE_WORDS * WORD_SIZE)
        if len(data) < BLOCK_SIZE_WORDS * WORD_SIZE:
            print(f"Block {block_num} is incomplete or past end of file.", file=sys.stderr)
            sys.exit(1)
        words = struct.unpack('<' + 'H'*BLOCK_SIZE_WORDS, data)
        for i in range(0, BLOCK_SIZE_WORDS, 8):
            chunk = words[i:i+8]
            chunk_str = ' '.join(f"{w:04o}" for w in chunk)
            print(f"{i:04o}: {chunk_str}")


# Move print_os8_directory above main()
def print_os8_directory(image_path, dir_block=1):
    BLOCK_SIZE_WORDS = 512
    WORD_SIZE = 2
    offset = dir_block * BLOCK_SIZE_WORDS * WORD_SIZE
    with open(image_path, 'rb') as f:
        f.seek(offset)
        data = f.read(BLOCK_SIZE_WORDS * WORD_SIZE)
        if len(data) < BLOCK_SIZE_WORDS * WORD_SIZE:
            print(f"Directory block {dir_block} is incomplete or past end of file.", file=sys.stderr)
            sys.exit(1)
        words = struct.unpack('<' + 'H'*BLOCK_SIZE_WORDS, data)
        print("OS/8 Directory (block %d):" % dir_block)
        print("  FILE      EXT  START  LENGTH FLAGS")
        for i in range(0, BLOCK_SIZE_WORDS, 6):
            entry = words[i:i+6]
            if all(w == 0 for w in entry):
                continue
            def sixbit_to_ascii(word, count):
                chars = []
                for j in range(count):
                    c = (word >> (6 * (count - 1 - j))) & 0x3F
                    if c == 0:
                        chars.append(' ')
                    elif 1 <= c <= 26:
                        chars.append(chr(ord('A') + c - 1))
                    elif 27 <= c <= 36:
                        chars.append(chr(ord('0') + c - 27))
                    else:
                        chars.append('_')
                return ''.join(chars)
            filename = sixbit_to_ascii(entry[0], 2) + sixbit_to_ascii(entry[1] >> 6, 2) + sixbit_to_ascii(((entry[1] & 0x3F) << 6) | (entry[2] >> 6), 2)
            ext = sixbit_to_ascii(entry[2], 2)[:2] + sixbit_to_ascii(entry[3] >> 6, 1)
            start = entry[3] & 0x3FF
            length = entry[4] & 0x3FF
            flags = entry[5]
            if filename.strip() == '' and ext.strip() == '':
                continue
            print(f"  {filename:<8} {ext:<3} {start:5o}  {length:6o}  {flags:04o}")

def main():
    if len(sys.argv) < 2:
        print("Usage: tc08 read <tape-image> <block> | tc08 dir <tape-image>", file=sys.stderr)
        sys.exit(2)
    if sys.argv[1] == 'read' and len(sys.argv) == 4:
        _, _, image_path, block = sys.argv
        if not os.path.isfile(image_path):
            print(f"File not found: {image_path}", file=sys.stderr)
            sys.exit(1)
        read_block(image_path, block)
    elif sys.argv[1] == 'dir' and len(sys.argv) == 3:
        _, _, image_path = sys.argv
        if not os.path.isfile(image_path):
            print(f"File not found: {image_path}", file=sys.stderr)
            sys.exit(1)
        print_os8_directory(image_path)
    else:
        print("Usage: tc08 read <tape-image> <block> | tc08 dir <tape-image>", file=sys.stderr)
        sys.exit(2)

if __name__ == "__main__":
    main()
